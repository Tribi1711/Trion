<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRION · AI</title>
    <meta name="description" content="Asistente AI con visión y búsqueda">
    <meta name="theme-color" content="#7c3aed">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0c;
            --bg-secondary: #111114;
            --surface: #1a1a1f;
            --surface-light: #22222a;
            --accent-primary: #7c3aed;
            --accent-secondary: #a78bfa;
            --accent-glow: rgba(124, 58, 237, 0.4);
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-dim: #606070;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.02) inset;
            --glow-primary: 0 0 30px rgba(124, 58, 237, 0.3);
            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
            --sidebar-width: 280px;
            --header-height: 70px;
            --input-height: 56px;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(124, 58, 237, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(167, 139, 250, 0.08) 0%, transparent 40%);
            position: relative;
            overflow: hidden;
        }

        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .splash-screen.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .splash-content {
            text-align: center;
        }

        .splash-logo {
            width: 130px;
            height: 130px;
            border-radius: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            box-shadow: 0 0 80px var(--accent-glow);
            overflow: hidden;
        }

        .splash-logo img {
            width: 75px;
            height: 75px;
            object-fit: contain;
            filter: brightness(0) invert(1);
            display: block;
        }

        .splash-logo i {
            font-size: 75px;
            color: white;
        }

        .splash-title {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .splash-loader span {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: var(--accent-primary);
            border-radius: 50%;
            margin: 0 6px;
            animation: splashLoader 1.4s infinite;
        }

        .splash-loader span:nth-child(2) { animation-delay: 0.2s; background: var(--accent-secondary); }
        .splash-loader span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes splashLoader {
            0%, 60%, 100% { transform: scale(1); opacity: 0.3; }
            30% { transform: scale(1.5); opacity: 1; }
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
            position: relative;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
            animation-delay: 2s;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .chat-sidebar {
            width: var(--sidebar-width);
            background: rgba(10, 10, 12, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 100;
        }

        @media (max-width: 768px) {
            .chat-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                z-index: 2000;
                width: 280px;
            }

            .chat-sidebar.open {
                transform: translateX(0);
            }
        }

        .sidebar-header {
            padding: 25px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-logo {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .sidebar-logo img {
            width: 24px;
            height: 24px;
            object-fit: contain;
            filter: brightness(0) invert(1);
            display: block;
        }

        .sidebar-logo i {
            font-size: 24px;
            color: white;
        }

        .sidebar-header h2 {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
        }

        .new-chat-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .new-chat-btn:hover {
            background: rgba(124, 58, 237, 0.2);
            color: white;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px 12px;
        }

        .chat-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-list::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 10px;
        }

        .chat-item {
            padding: 14px 15px;
            border-radius: 24px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-size: 0.9rem;
            position: relative;
        }

        .chat-item i {
            font-size: 1rem;
            width: 20px;
            color: var(--text-dim);
        }

        .chat-item span {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item .delete-chat {
            opacity: 0;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-item:hover .delete-chat {
            opacity: 1;
        }

        .chat-item .delete-chat:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .chat-item:hover {
            background: rgba(124, 58, 237, 0.1);
        }

        .chat-item.active {
            background: rgba(124, 58, 237, 0.2);
            color: var(--accent-secondary);
        }

        .chat-item.active i {
            color: var(--accent-secondary);
        }

        .chat-actions {
            border-top: 1px solid var(--border-subtle);
            padding: 20px 15px;
        }

        .chat-actions button {
            width: 100%;
            padding: 12px 15px;
            border: none;
            background: transparent;
            border-radius: 24px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-body);
            font-size: 0.9rem;
        }

        .chat-actions button:hover {
            background: rgba(124, 58, 237, 0.15);
            color: white;
        }

        .chat-actions button i {
            width: 20px;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: rgba(17, 17, 20, 0.7);
            backdrop-filter: blur(20px);
            position: relative;
        }

        header {
            padding: 0 25px;
            background: rgba(10, 10, 12, 0.6);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--header-height);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle {
            display: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.3rem;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }
        }

        .logo {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .logo img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            filter: brightness(0) invert(1);
            display: block;
        }

        .logo i {
            font-size: 28px;
            color: white;
        }

        .brand h1 {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: var(--font-display);
            background: linear-gradient(135deg, #ffffff 0%, #e0e0ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        #status {
            font-size: 0.75rem;
            font-weight: 500;
            background: rgba(124, 58, 237, 0.15);
            padding: 5px 15px;
            border-radius: 40px;
            color: var(--accent-secondary);
            border: 1px solid rgba(124, 58, 237, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 5px;
        }

        #status i {
            font-size: 0.5rem;
            color: var(--accent-primary);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-dropdown {
            position: relative;
        }

        .mode-dropdown-btn {
            padding: 8px 18px;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: var(--font-display);
            color: var(--text-primary);
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            background: rgba(124, 58, 237, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .mode-dropdown-content {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(26, 26, 31, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 18px;
            padding: 8px;
            min-width: 180px;
            box-shadow: var(--shadow-xl);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-5px);
            transition: all 0.2s;
            z-index: 10;
        }

        .mode-dropdown:hover .mode-dropdown-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .mode-option {
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-option:hover {
            background: rgba(124, 58, 237, 0.15);
            color: white;
        }

        .mode-option.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .mode-option.vision-mode {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .mode-option.vision-mode i {
            color: white;
        }

        .btn-clear {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
            font-size: 0.85rem;
            border: 1px solid var(--border-subtle);
            padding: 8px 18px;
            border-radius: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-clear:hover {
            background: rgba(124, 58, 237, 0.15);
            color: white;
        }

        .call-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 0 25px var(--accent-glow);
        }

        .call-button.active {
            background: linear-gradient(135deg, #ef4444, #f97316);
        }

        .call-button.listening {
            background: linear-gradient(135deg, #10b981, #34d399);
        }

        .chat-box {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chat-box::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-box::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 10px;
        }

        .message {
            max-width: 75%;
            padding: 15px 22px;
            border-radius: 26px;
            font-size: 0.95rem;
            line-height: 1.5;
            animation: messageFloat 0.3s ease;
        }

        @keyframes messageFloat {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-bottom-right-radius: 8px;
        }

        .ai {
            align-self: flex-start;
            background: rgba(26, 26, 31, 0.8);
            color: var(--text-primary);
            border-bottom-left-radius: 8px;
            border: 1px solid rgba(124, 58, 237, 0.2);
        }

        .ai .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .ai .message-header img {
            width: 16px;
            height: 16px;
            object-fit: contain;
            filter: brightness(0) invert(1);
            display: block;
        }

        .ai .message-header i {
            font-size: 16px;
            color: var(--accent-secondary);
        }

        .ai .message-header span {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent-secondary);
            text-transform: uppercase;
        }

        .message-image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 18px;
            margin-top: 10px;
            border: 2px solid rgba(124, 58, 237, 0.3);
        }

        .message-file-preview {
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 14px;
            padding: 10px 14px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-file-preview i {
            font-size: 24px;
            color: var(--accent-secondary);
        }

        .thinking {
            align-self: flex-start;
            background: rgba(26, 26, 31, 0.6);
            padding: 18px 28px;
            border-radius: 26px;
            border-bottom-left-radius: 8px;
        }

        .thinking-dots {
            display: flex;
            gap: 6px;
        }
        
        .thinking-dots span {
            width: 7px;
            height: 7px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: thinking-pulse 1.4s infinite;
        }
        
        .thinking-dots span:nth-child(2) { animation-delay: 0.2s; background: var(--accent-secondary); }
        .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes thinking-pulse {
            0%, 60%, 100% { opacity: 0.3; transform: scale(1); }
            30% { opacity: 1; transform: scale(1.3); }
        }

        .input-area {
            padding: 20px 25px 25px;
            background: rgba(10, 10, 12, 0.6);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-buttons {
            display: flex;
            gap: 8px;
        }

        .attach-btn {
            width: var(--input-height);
            height: var(--input-height);
            border-radius: 50%;
            border: 1px solid var(--border-subtle);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.2s;
        }

        .attach-btn:hover {
            border-color: var(--accent-primary);
            color: white;
            background: rgba(124, 58, 237, 0.1);
        }

        .attach-btn input {
            display: none;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 40px;
            padding: 6px 16px;
            animation: slideIn 0.2s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .file-name {
            font-size: 0.8rem;
            color: var(--accent-secondary);
            max-width: 200px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .file-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-wrapper {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-primary);
            font-size: 1rem;
            opacity: 0.7;
        }

        input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border-radius: 50px;
            border: 1px solid var(--border-subtle);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
            outline: none;
            font-size: 0.95rem;
            height: var(--input-height);
        }

        input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        button#send-btn {
            padding: 0 28px;
            border-radius: 50px;
            border: none;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            height: var(--input-height);
            min-width: 100px;
            text-transform: uppercase;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        button#send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 0 30px var(--accent-glow);
        }

        .welcome-message {
            text-align: center;
            margin: auto;
            max-width: 400px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 50px;
            border: 1px solid var(--border-subtle);
        }

        .welcome-message h3 {
            font-family: var(--font-display);
            font-size: 1.8rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, white, var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-message p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .version-badge {
            display: inline-block;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(16, 185, 129, 0.3);
            margin-top: 10px;
        }

        .voice-indicator {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 14px 30px;
            border-radius: 60px;
            color: white;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 40px var(--accent-glow);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            white-space: nowrap;
            font-size: 1rem;
        }

        .voice-indicator.speaking {
            border-color: #10b981;
        }

        .voice-indicator i {
            font-size: 1.2rem;
        }

        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-width: 380px;
            margin: 0 auto;
            background: rgba(26, 26, 31, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 35px;
            padding: 18px 22px;
            box-shadow: var(--shadow-xl);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 2000;
        }

        .install-prompt.show {
            display: flex;
        }

        .install-prompt i {
            font-size: 28px;
            color: var(--accent-secondary);
        }

        .install-prompt-content {
            flex: 1;
        }

        .install-prompt-content h4 {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 3px;
        }

        .install-prompt-content p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .install-prompt button {
            padding: 8px 18px;
            border: none;
            border-radius: 35px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            font-family: var(--font-body);
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .install-prompt .close-btn {
            background: transparent;
            color: var(--text-dim);
            padding: 8px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            :root {
                --header-height: 60px;
                --input-height: 50px;
            }

            body {
                padding: 0;
            }

            .app-container {
                height: 100vh;
                width: 100vw;
                overflow: hidden;
            }

            .chat-container {
                width: 100%;
                border-radius: 0;
            }

            header {
                padding: 0 15px;
            }

            .brand {
                gap: 8px;
            }

            .brand h1 {
                font-size: 1.3rem;
            }

            .logo {
                width: 40px;
                height: 40px;
            }

            .logo img {
                width: 24px;
                height: 24px;
            }

            .logo i {
                font-size: 24px;
            }

            #status {
                font-size: 0.65rem;
                padding: 4px 10px;
                gap: 4px;
            }

            .header-controls {
                gap: 5px;
            }

            .mode-dropdown-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
                gap: 4px;
            }

            .btn-clear {
                padding: 6px 12px;
                font-size: 0.75rem;
                gap: 4px;
            }

            .call-button {
                width: 42px;
                height: 42px;
                font-size: 1.1rem;
            }

            .chat-box {
                padding: 15px;
                gap: 15px;
            }

            .message {
                max-width: 85%;
                padding: 12px 18px;
                font-size: 0.9rem;
            }

            .input-area {
                padding: 12px 15px 18px;
                gap: 6px;
            }

            .file-buttons {
                gap: 5px;
            }

            .attach-btn {
                width: 44px;
                height: 44px;
                font-size: 1.1rem;
            }

            .file-info {
                padding: 4px 12px;
                gap: 6px;
            }

            .file-name {
                font-size: 0.7rem;
                max-width: 120px;
            }

            .input-wrapper {
                min-width: 100px;
            }

            .input-wrapper i {
                left: 15px;
                font-size: 0.9rem;
            }

            input {
                padding: 12px 15px 12px 42px;
                font-size: 0.9rem;
                height: 44px;
            }

            button#send-btn {
                padding: 0 16px;
                font-size: 0.8rem;
                min-width: 70px;
                height: 44px;
            }

            .welcome-message {
                padding: 25px;
                max-width: 300px;
            }

            .welcome-message h3 {
                font-size: 1.4rem;
            }

            .welcome-message p {
                font-size: 0.85rem;
            }

            .voice-indicator {
                bottom: 80px;
                padding: 10px 20px;
                font-size: 0.85rem;
            }

            .install-prompt {
                left: 15px;
                right: 15px;
                max-width: none;
                padding: 15px;
            }
        }

        @media (max-width: 380px) {
            .brand h1 {
                font-size: 1.1rem;
            }

            .mode-dropdown-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }

            .btn-clear {
                padding: 5px 8px;
                font-size: 0.7rem;
            }

            .call-button {
                width: 38px;
                height: 38px;
                font-size: 1rem;
            }

            .file-name {
                max-width: 80px;
            }

            button#send-btn {
                min-width: 60px;
                padding: 0 10px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>

<!-- Splash Screen -->
<div class="splash-screen" id="splashScreen">
    <div class="splash-content">
        <div class="splash-logo">
            <img src="logo.png" alt="TRION" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-brain\'></i>';">
        </div>
        <h1 class="splash-title">TRION</h1>
        <div class="splash-loader">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</div>

<!-- App container -->
<div class="app-container">
    <!-- Sidebar -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="logo.png" alt="TRION" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-brain\'></i>';">
            </div>
            <h2>Historial</h2>
            <button class="new-chat-btn" onclick="createNewChat()">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        
        <div class="chat-list" id="chatList"></div>
        
        <div class="chat-actions">
            <button onclick="downloadChats()">
                <i class="fas fa-download"></i>
                <span>Descargar</span>
            </button>
            <button onclick="clearAllChats()">
                <i class="fas fa-trash"></i>
                <span>Limpiar todo</span>
            </button>
        </div>
    </div>

    <!-- Chat container -->
    <div class="chat-container">
        <header>
            <div class="brand">
                <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <img src="logo.png" alt="TRION" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-brain\'></i>';">
                </div>
                <h1>TRION</h1>
                <span id="status"><i class="fas fa-circle"></i> NORMAL</span>
            </div>
            <div class="header-controls">
                <div class="mode-dropdown">
                    <button class="mode-dropdown-btn">
                        <span id="selectedMode">Normal</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="mode-dropdown-content">
                        <div class="mode-option" data-mode="rapido" id="rapidoMode">
                            <i class="fas fa-bolt"></i> Rápido
                        </div>
                        <div class="mode-option active" data-mode="normal" id="normalMode">
                            <i class="fas fa-robot"></i> Normal
                        </div>
                        <div class="mode-option" data-mode="pro" id="proMode">
                            <i class="fas fa-crown"></i> Pro
                        </div>
                        <div class="mode-option vision-mode" data-mode="vision" id="visionMode">
                            <i class="fas fa-eye"></i> TRION VISION
                        </div>
                    </div>
                </div>
                <button class="btn-clear" onclick="clearChat()"><i class="fas fa-sparkles"></i> Nuevo</button>
                <button class="call-button" id="call-button">
                    <i class="fas fa-phone"></i>
                </button>
            </div>
        </header>

        <div id="chat-box" class="chat-box"></div>

        <div class="input-area">
            <div class="file-buttons">
                <label class="attach-btn" id="vision-attach-btn">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="imageUpload" accept="image/*">
                </label>
                <label class="attach-btn">
                    <i class="fas fa-file"></i>
                    <input type="file" id="fileUpload" accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.csv,.json,.js,.py,.html,.css">
                </label>
            </div>
            
            <div id="fileInfo" class="file-info" style="display: none;">
                <i class="fas fa-file"></i>
                <span id="fileName" class="file-name"></span>
                <button class="file-remove" onclick="removeFile()"><i class="fas fa-times"></i></button>
            </div>

            <div class="input-wrapper">
                <i class="fas fa-chevron-right"></i>
                <input type="text" id="user-input" placeholder="Pregúntale algo a Trion...">
            </div>
            <button id="send-btn"><i class="fas fa-paper-plane"></i> Enviar</button>
        </div>
    </div>
</div>

<!-- Install prompt -->
<div class="install-prompt" id="installPrompt">
    <i class="fas fa-download"></i>
    <div class="install-prompt-content">
        <h4>Instalar TRION</h4>
        <p>Instala como app para acceso rápido</p>
    </div>
    <button onclick="installPWA()" id="installBtn">Instalar</button>
    <button class="close-btn" onclick="hideInstallPrompt()">
        <i class="fas fa-times"></i>
    </button>
</div>

<script>
    (function() {
        // Splash screen
        setTimeout(() => {
            document.getElementById('splashScreen').classList.add('fade-out');
        }, 2000);

        // ===== CONFIGURACIÓN =====
        const API_KEY = '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';
        const API_URL = 'https://api.groq.com/openai/v1/chat/completions';
        
        // MODELOS
        const VISION_MODEL = 'meta-llama/llama-4-maverick-17b-128e-instruct';
        const TEXT_MODEL = 'llama-3.3-70b-versatile';

        // System prompts - SIN MENCIONAR LLAMA
        const PROMPTS = {
            rapido: "Eres Trion, un asistente AI experto creado por Hugo Tribaldos. Hoy es " + new Date().toLocaleDateString('es-ES') + ". Responde de forma MUY CONCISA, máximo 2-3 frases. Usa la información proporcionada. Tono profesional.",
            normal: "Eres Trion, un asistente AI experto creado por Hugo Tribaldos. Hoy es " + new Date().toLocaleDateString('es-ES') + ". Responde de forma clara y útil. Usa la información proporcionada. Tono profesional.",
            pro: "Eres Trion, un asistente AI experto creado por Hugo Tribaldos. Hoy es " + new Date().toLocaleDateString('es-ES') + ". Responde de forma DETALLADA. Usa la información proporcionada. Explica conceptos a fondo.",
            vision: "Eres TRION VISION, un asistente AI especializado en análisis de imágenes creado por Hugo Tribaldos. Hoy es " + new Date().toLocaleDateString('es-ES') + ". Tu ÚNICA función es analizar imágenes. Cuando recibas una imagen, debes: 1) Observar todos los detalles de la imagen 2) Describir qué ves incluyendo objetos, personas, colores, texto, composición 3) Analizar el contexto y propósito de la imagen 4) Responder SIEMPRE en español. No puedes responder preguntas que no estén relacionadas con la imagen. Si no hay imagen, debes decir 'Por favor, sube una imagen para que pueda analizarla'."
        };

        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const callButton = document.getElementById('call-button');
        const statusDiv = document.getElementById('status');
        const selectedModeSpan = document.getElementById('selectedMode');
        const rapidMode = document.getElementById('rapidoMode');
        const normalMode = document.getElementById('normalMode');
        const proMode = document.getElementById('proMode');
        const visionMode = document.getElementById('visionMode');
        const imageUpload = document.getElementById('imageUpload');
        const fileUpload = document.getElementById('fileUpload');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');

        let currentMode = 'normal';
        let currentImageBase64 = null;
        let currentImageMime = null;
        let currentFile = null;
        let currentFileContent = null;

        // Chats
        let chats = {};
        let currentChatId = 'default';

        // Voice
        let recognition = null;
        let isCallActive = false;
        let isSpeaking = false;
        let autoRestartRecognition = true;
        let voiceIndicator = null;
        let preferredVoice = null;

        // PWA
        let deferredPrompt = null;

        // Cache de búsquedas
        let searchCache = new Map();

        // Fecha actual para la versión
        const today = new Date();
        const versionDate = today.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.');

        // Cargar chats
        function loadChats() {
            try {
                const saved = localStorage.getItem('trion_chats');
                chats = saved ? JSON.parse(saved) : { default: [] };
                if (!chats[currentChatId]) currentChatId = 'default';
                loadHistory();
                updateSidebar();
            } catch (e) {
                chats = { default: [] };
            }
        }

        function saveChats() {
            localStorage.setItem('trion_chats', JSON.stringify(chats));
            updateSidebar();
        }

        function updateSidebar() {
            const chatList = document.getElementById('chatList');
            if (!chatList) return;
            
            chatList.innerHTML = '';
            
            Object.keys(chats).forEach(chatId => {
                const lastMessage = chats[chatId].find(msg => msg.role === 'user')?.text || 'Chat vacío';
                const preview = lastMessage.substring(0, 25) + (lastMessage.length > 25 ? '...' : '');
                
                const item = document.createElement('div');
                item.className = 'chat-item' + (chatId === currentChatId ? ' active' : '');
                
                item.innerHTML = `
                    <i class="fas fa-message"></i>
                    <span>${preview}</span>
                    <button class="delete-chat" onclick="deleteChat('${chatId}', event)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-chat')) {
                        switchChat(chatId);
                    }
                });
                
                chatList.appendChild(item);
            });
        }

        window.deleteChat = function(chatId, event) {
            event.stopPropagation();
            if (Object.keys(chats).length === 1) return;
            
            delete chats[chatId];
            if (currentChatId === chatId) {
                currentChatId = Object.keys(chats)[0];
                loadHistory();
            }
            saveChats();
        };

        window.switchChat = function(chatId) {
            currentChatId = chatId;
            loadHistory();
            updateSidebar();
            if (window.innerWidth <= 768) {
                document.getElementById('chatSidebar').classList.remove('open');
            }
        };

        window.createNewChat = function() {
            const newId = 'chat_' + Date.now();
            chats[newId] = [];
            currentChatId = newId;
            saveChats();
            loadHistory();
            if (window.innerWidth <= 768) {
                document.getElementById('chatSidebar').classList.remove('open');
            }
        };

        window.downloadChats = function() {
            const dataStr = JSON.stringify(chats, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trion_chats.json';
            a.click();
        };

        window.clearAllChats = function() {
            if (confirm('¿Eliminar todos los chats?')) {
                chats = { default: [] };
                currentChatId = 'default';
                saveChats();
                loadHistory();
            }
        };

        window.toggleSidebar = function() {
            document.getElementById('chatSidebar').classList.toggle('open');
        };

        // Voice setup
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'es-ES';

            recognition.onstart = () => {
                callButton.classList.add('listening');
                callButton.innerHTML = '<i class="fas fa-microphone"></i>';
                showVoiceIndicator('Escuchando...', false);
            };

            recognition.onend = () => {
                callButton.classList.remove('listening');
                if (!isCallActive) callButton.innerHTML = '<i class="fas fa-phone"></i>';
                if (voiceIndicator && !isSpeaking) {
                    voiceIndicator.remove();
                    voiceIndicator = null;
                }
                if (isCallActive && autoRestartRecognition && !isSpeaking) {
                    setTimeout(() => {
                        if (isCallActive && !isSpeaking && recognition) {
                            try { recognition.start(); } catch (e) {}
                        }
                    }, 300);
                }
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                if (transcript && isCallActive) {
                    userInput.value = transcript;
                    try { recognition.stop(); } catch (e) {}
                    await sendMessage(true);
                }
            };

            recognition.onerror = (event) => {
                if (isCallActive && event.error !== 'no-speech') {
                    stopCall();
                }
            };
        }

        function getBestVoice() {
            return new Promise((resolve) => {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    const spanishVoices = voices.filter(v => v.lang.includes('es'));
                    resolve(spanishVoices[0] || voices[0]);
                } else {
                    resolve(null);
                }
            });
        }

        async function speakText(text) {
            return new Promise(async (resolve) => {
                if (!window.speechSynthesis) {
                    resolve();
                    return;
                }
                
                speechSynthesis.cancel();
                
                if (!preferredVoice) {
                    preferredVoice = await getBestVoice();
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }

                utterance.onstart = () => {
                    isSpeaking = true;
                    callButton.classList.add('active');
                    callButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                    showVoiceIndicator('Hablando...', true);
                };

                utterance.onend = () => {
                    isSpeaking = false;
                    callButton.classList.remove('active');
                    if (isCallActive) {
                        callButton.classList.add('listening');
                        callButton.innerHTML = '<i class="fas fa-microphone"></i>';
                    }
                    if (voiceIndicator) {
                        voiceIndicator.remove();
                        voiceIndicator = null;
                    }
                    resolve();
                };

                utterance.onerror = () => {
                    isSpeaking = false;
                    resolve();
                };

                speechSynthesis.speak(utterance);
            });
        }

        function showVoiceIndicator(text, isSpeakingMode) {
            if (voiceIndicator) voiceIndicator.remove();
            voiceIndicator = document.createElement('div');
            voiceIndicator.className = 'voice-indicator' + (isSpeakingMode ? ' speaking' : '');
            voiceIndicator.innerHTML = `<i class="fas fa-${isSpeakingMode ? 'volume-up' : 'microphone'}"></i> ${text}`;
            document.body.appendChild(voiceIndicator);
        }

        async function startCall() {
            if (!recognition) {
                alert('Reconocimiento de voz no soportado');
                return;
            }
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                isCallActive = true;
                autoRestartRecognition = true;
                callButton.classList.add('active', 'listening');
                callButton.innerHTML = '<i class="fas fa-microphone"></i>';
                statusDiv.innerHTML = '<i class="fas fa-circle"></i> LLAMADA';
                setTimeout(() => {
                    if (isCallActive && recognition) recognition.start();
                }, 200);
            } catch (err) {
                alert('Permiso de micrófono requerido');
            }
        }

        function stopCall() {
            isCallActive = false;
            autoRestartRecognition = false;
            if (recognition) recognition.stop();
            speechSynthesis.cancel();
            callButton.classList.remove('active', 'listening');
            callButton.innerHTML = '<i class="fas fa-phone"></i>';
            if (voiceIndicator) voiceIndicator.remove();
            updateModeUI();
        }

        callButton.addEventListener('click', (e) => {
            e.preventDefault();
            isCallActive ? stopCall() : startCall();
        });

        // Cargar voces
        if (speechSynthesis) {
            if (speechSynthesis.getVoices().length > 0) {
                getBestVoice().then(voice => preferredVoice = voice);
            } else {
                speechSynthesis.addEventListener('voiceschanged', () => {
                    getBestVoice().then(voice => preferredVoice = voice);
                }, { once: true });
            }
        }

        function getActiveSystemPrompt() {
            return PROMPTS[currentMode];
        }

        function getActiveModel() {
            if (currentMode === 'vision') {
                return VISION_MODEL;
            }
            return TEXT_MODEL;
        }

        function updateModeUI() {
            document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('active'));
            
            if (currentMode === 'rapido') {
                rapidMode.classList.add('active');
                selectedModeSpan.textContent = 'Rápido';
                if (!isCallActive) statusDiv.innerHTML = '<i class="fas fa-circle"></i> RÁPIDO';
                document.getElementById('vision-attach-btn').style.borderColor = 'var(--border-subtle)';
                document.getElementById('vision-attach-btn').style.boxShadow = 'none';
            } else if (currentMode === 'pro') {
                proMode.classList.add('active');
                selectedModeSpan.textContent = 'Pro';
                if (!isCallActive) statusDiv.innerHTML = '<i class="fas fa-circle"></i> PRO';
                document.getElementById('vision-attach-btn').style.borderColor = 'var(--border-subtle)';
                document.getElementById('vision-attach-btn').style.boxShadow = 'none';
            } else if (currentMode === 'vision') {
                visionMode.classList.add('active');
                selectedModeSpan.textContent = 'TRION VISION';
                if (!isCallActive) statusDiv.innerHTML = '<i class="fas fa-circle"></i> VISIÓN';
                document.getElementById('vision-attach-btn').style.borderColor = '#10b981';
                document.getElementById('vision-attach-btn').style.boxShadow = '0 0 15px #10b981';
            } else {
                normalMode.classList.add('active');
                selectedModeSpan.textContent = 'Normal';
                if (!isCallActive) statusDiv.innerHTML = '<i class="fas fa-circle"></i> NORMAL';
                document.getElementById('vision-attach-btn').style.borderColor = 'var(--border-subtle)';
                document.getElementById('vision-attach-btn').style.boxShadow = 'none';
            }
        }

        rapidMode.addEventListener('click', () => { currentMode = 'rapido'; updateModeUI(); });
        normalMode.addEventListener('click', () => { currentMode = 'normal'; updateModeUI(); });
        proMode.addEventListener('click', () => { currentMode = 'pro'; updateModeUI(); });
        visionMode.addEventListener('click', () => { currentMode = 'vision'; updateModeUI(); });

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function removeFile() {
            currentImageBase64 = null;
            currentImageMime = null;
            currentFile = null;
            currentFileContent = null;
            imageUpload.value = '';
            fileUpload.value = '';
            fileInfo.style.display = 'none';
        }
        window.removeFile = removeFile;

        async function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        imageUpload.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona una imagen válida');
                imageUpload.value = '';
                return;
            }

            removeFile();
            
            try {
                currentImageBase64 = await readFileAsBase64(file);
                currentImageMime = file.type;
                fileName.textContent = `📷 ${file.name} (${formatFileSize(file.size)})`;
                fileInfo.style.display = 'flex';
                
                if (currentMode === 'vision') {
                    statusDiv.innerHTML = '<i class="fas fa-circle"></i> VISIÓN: IMAGEN LISTA';
                } else {
                    statusDiv.innerHTML = '<i class="fas fa-circle"></i> IMAGEN LISTA (cambia a VISIÓN)';
                }
            } catch (error) {
                alert('Error al leer la imagen');
                imageUpload.value = '';
            }
        });

        fileUpload.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                alert('Archivo muy grande (máx 10MB)');
                fileUpload.value = '';
                return;
            }

            removeFile();
            
            try {
                currentFile = file;
                currentFileContent = await readFileAsText(file);
                fileName.textContent = `📄 ${file.name} (${formatFileSize(file.size)})`;
                fileInfo.style.display = 'flex';
                statusDiv.innerHTML = '<i class="fas fa-circle"></i> ARCHIVO LISTO';
            } catch (error) {
                alert('Error al leer el archivo');
                fileUpload.value = '';
            }
        });

        function loadHistory() {
            const history = chats[currentChatId] || [];
            chatBox.innerHTML = '';
            if (history.length === 0) {
                showWelcomeMessage();
            } else {
                history.forEach(msg => {
                    if (msg.role === 'user') {
                        if (msg.imageData) {
                            appendUserMessageWithImage(msg.text, msg.imageData, msg.mime, false);
                        } else if (msg.fileData) {
                            appendUserMessageWithFile(msg.text, msg.fileName, msg.fileSize, false);
                        } else {
                            appendMessage('user', msg.text, false);
                        }
                    } else {
                        appendMessage('ai', msg.text, false);
                    }
                });
            }
        }

        function showWelcomeMessage() {
            const welcomeDiv = document.createElement('div');
            welcomeDiv.classList.add('welcome-message');
            welcomeDiv.innerHTML = `
                <h3>TRION AI</h3>
                <p>Selecciona <span style="color:#10b981; font-weight:bold;">TRION VISION</span> para analizar imágenes</p>
                <div class="version-badge">v1.6 · ${versionDate}</div>
                <span style="color: var(--accent-secondary); font-size: 0.8rem; display: flex; flex-direction: column; gap: 5px; margin-top: 15px;">
                    <span><i class="fas fa-bolt"></i> Rápido: Texto conciso</span>
                    <span><i class="fas fa-robot"></i> Normal: Texto equilibrado</span>
                    <span><i class="fas fa-crown"></i> Pro: Texto detallado</span>
                    <span><i class="fas fa-eye" style="color:#10b981;"></i> TRION VISION: Análisis de imágenes</span>
                </span>
            `;
            chatBox.appendChild(welcomeDiv);
        }

        function saveMessage(role, text, additionalData = {}) {
            if (!chats[currentChatId]) chats[currentChatId] = [];
            chats[currentChatId].push({ role, text, ...additionalData });
            saveChats();
        }

        function appendMessage(role, text, shouldSave = true) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', role);
            
            if (role === 'ai') {
                const header = document.createElement('div');
                header.classList.add('message-header');
                
                const logoImg = document.createElement('img');
                logoImg.src = 'logo.png';
                logoImg.alt = 'TRION';
                logoImg.onerror = function() {
                    this.style.display = 'none';
                    const fallback = document.createElement('i');
                    fallback.className = 'fas fa-brain';
                    header.insertBefore(fallback, this);
                    this.remove();
                };
                
                const span = document.createElement('span');
                span.textContent = currentMode === 'vision' ? 'TRION VISION' : 'TRION';
                if (currentMode === 'vision') {
                    span.style.color = '#10b981';
                }
                
                header.appendChild(logoImg);
                header.appendChild(span);
                msgDiv.appendChild(header);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = text.replace(/\n/g, '<br>');
            msgDiv.appendChild(contentDiv);
            
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            if (shouldSave) saveMessage(role, text);
        }

        function appendUserMessageWithImage(text, base64Data, mimeType, shouldSave = true) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', 'user');
            
            if (text && text.trim()) {
                const contentDiv = document.createElement('div');
                contentDiv.textContent = text;
                msgDiv.appendChild(contentDiv);
            }
            
            const img = document.createElement('img');
            img.src = `data:${mimeType};base64,${base64Data}`;
            img.classList.add('message-image-preview');
            img.alt = 'Imagen adjunta';
            msgDiv.appendChild(img);
            
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if (shouldSave) {
                saveMessage('user', text, { 
                    imageData: base64Data, 
                    mime: mimeType 
                });
            }
        }

        function appendUserMessageWithFile(text, fileName, fileSize, shouldSave = true) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', 'user');
            
            if (text && text.trim()) {
                const contentDiv = document.createElement('div');
                contentDiv.textContent = text;
                msgDiv.appendChild(contentDiv);
            }
            
            const fileDiv = document.createElement('div');
            fileDiv.className = 'message-file-preview';
            fileDiv.innerHTML = `
                <i class="fas fa-file-alt"></i>
                <div>
                    <div style="font-weight:500;">${fileName}</div>
                    <div style="font-size:0.7rem; color:var(--text-secondary);">${fileSize}</div>
                </div>
            `;
            msgDiv.appendChild(fileDiv);
            
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if (shouldSave) {
                saveMessage('user', text, { 
                    fileName: fileName, 
                    fileSize: fileSize 
                });
            }
        }

        function showThinkingMessage() {
            const thinkingDiv = document.createElement('div');
            thinkingDiv.classList.add('thinking');
            thinkingDiv.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div>';
            chatBox.appendChild(thinkingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return thinkingDiv;
        }

        window.clearChat = function() {
            if (isCallActive) stopCall();
            chats[currentChatId] = [];
            saveChats();
            chatBox.innerHTML = '';
            showWelcomeMessage();
            removeFile();
            updateSidebar();
        };

        // ===== BÚSQUEDA EN WIKIPEDIA =====
        async function searchWikipedia(query) {
            const cacheKey = query.toLowerCase().trim();
            if (searchCache.has(cacheKey)) {
                return searchCache.get(cacheKey);
            }

            try {
                const term = encodeURIComponent(query.toLowerCase().trim());
                const directResponse = await fetch(`https://es.wikipedia.org/api/rest_v1/page/summary/${term}`);
                
                if (directResponse.ok) {
                    const data = await directResponse.json();
                    if (data.extract && data.extract.length > 100) {
                        const result = data.extract.substring(0, 1500);
                        searchCache.set(cacheKey, result);
                        return result;
                    }
                }

                const searchUrl = `https://es.wikipedia.org/w/api.php?action=query&list=search&srsearch=${term}&format=json&origin=*`;
                const searchResponse = await fetch(searchUrl);
                
                if (searchResponse.ok) {
                    const searchData = await searchResponse.json();
                    if (searchData.query?.search?.length > 0) {
                        const firstTitle = searchData.query.search[0].title;
                        const pageResponse = await fetch(`https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(firstTitle)}`);
                        
                        if (pageResponse.ok) {
                            const pageData = await pageResponse.json();
                            if (pageData.extract) {
                                const result = pageData.extract.substring(0, 1500);
                                searchCache.set(cacheKey, result);
                                return result;
                            }
                        }
                    }
                }

                return null;
            } catch (error) {
                console.error('Error en búsqueda:', error);
                return null;
            }
        }

        // Función para simular delay de procesamiento
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function sendMessage(isVoice = false) {
            const prompt = userInput.value.trim();
            
            const hasImage = !!currentImageBase64;
            const hasFile = !!currentFile;

            // Validaciones específicas para modo visión
            if (currentMode === 'vision') {
                if (!hasImage) {
                    appendMessage('ai', '👁️ Por favor, sube una imagen para que pueda analizarla. Estoy en modo TRION VISION y necesito una imagen para ayudarte.', true);
                    userInput.value = '';
                    return;
                }
            }

            if (!prompt && !hasImage && !hasFile) {
                if (isVoice) {
                    userInput.value = '';
                }
                return;
            }

            if (document.querySelector('.welcome-message')) {
                document.querySelector('.welcome-message').remove();
            }

            // Mostrar mensaje del usuario
            if (hasImage) {
                appendUserMessageWithImage(prompt, currentImageBase64, currentImageMime, true);
            } else if (hasFile) {
                appendUserMessageWithFile(prompt, currentFile.name, formatFileSize(currentFile.size), true);
            } else {
                appendMessage('user', prompt, true);
            }

            // LIMPIAR EL INPUT INMEDIATAMENTE
            userInput.value = '';

            const imageToSend = currentImageBase64;
            const mimeToSend = currentImageMime;
            const fileToSend = currentFile;
            const fileContentToSend = currentFileContent;
            
            removeFile();

            const thinkingMsg = showThinkingMessage();

            try {
                // DELAY DE 5 SEGUNDOS
                if (currentMode === 'vision') {
                    statusDiv.innerHTML = '<i class="fas fa-circle"></i> VISIÓN: ANALIZANDO... (5s)';
                } else {
                    statusDiv.innerHTML = '<i class="fas fa-circle"></i> PROCESANDO... (5s)';
                }
                await delay(5000);

                // Buscar información solo si NO estamos en modo visión
                let searchResult = null;
                if (currentMode !== 'vision' && !hasImage && !hasFile) {
                    statusDiv.innerHTML = '<i class="fas fa-circle"></i> BUSCANDO...';
                    searchResult = await searchWikipedia(prompt);
                }

                const history = chats[currentChatId] || [];
                let systemPrompt = getActiveSystemPrompt();
                
                if (searchResult) {
                    systemPrompt += `\n\nInformación actualizada:\n${searchResult}`;
                }

                let messages = [{ role: "system", content: systemPrompt }];
                
                const recentHistory = history.slice(-5);
                for (let msg of recentHistory) {
                    if (msg.role === 'user' && !msg.imageData && !msg.fileData) {
                        messages.push({ role: "user", content: msg.text });
                    } else if (msg.role === 'ai') {
                        messages.push({ role: "assistant", content: msg.text });
                    }
                }

                let userContent = [];
                
                if (prompt) {
                    userContent.push({ type: "text", text: prompt });
                }
                
                if (imageToSend) {
                    if (currentMode === 'vision') {
                        userContent.push({ 
                            type: "text", 
                            text: "Analiza esta imagen en detalle con TRION VISION. Describe todos los elementos que ves: objetos, personas, texto, colores, composición, contexto. Sé exhaustivo en tu análisis." 
                        });
                    }
                    
                    userContent.push({ 
                        type: "image_url", 
                        image_url: { 
                            url: `data:${mimeToSend};base64,${imageToSend}` 
                        } 
                    });
                }
                
                if (fileToSend && fileContentToSend) {
                    userContent.push({ 
                        type: "text", 
                        text: `Archivo adjunto: ${fileToSend.name}\n\nContenido:\n${fileContentToSend}` 
                    });
                }

                messages.push({ 
                    role: "user", 
                    content: userContent.length === 1 ? userContent[0].text : userContent 
                });

                const temperature = currentMode === 'rapido' ? 0.3 : currentMode === 'pro' ? 0.8 : 0.6;
                const maxTokens = currentMode === 'pro' ? 4096 : 2048;

                const modelToUse = getActiveModel();

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: modelToUse,
                        messages: messages,
                        max_tokens: maxTokens,
                        temperature: temperature
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error API:', errorText);
                    throw new Error(`Error ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Respuesta inválida');
                }
                
                let aiResponse = data.choices[0].message.content;
                aiResponse = aiResponse.replace(/[*]/g, '').trim();

                thinkingMsg.remove();
                appendMessage('ai', aiResponse, true);

                if (isCallActive) {
                    autoRestartRecognition = false;
                    await speakText(aiResponse);
                    setTimeout(() => {
                        autoRestartRecognition = true;
                        if (isCallActive && recognition) {
                            try { recognition.start(); } catch (e) {}
                        }
                    }, 500);
                }
                
            } catch (error) {
                console.error('Error:', error);
                thinkingMsg.remove();
                
                let errorMessage = 'Lo siento, hubo un error. Intenta de nuevo.';
                
                if (currentMode === 'vision') {
                    errorMessage = '👁️ Error al analizar la imagen. Por favor, intenta de nuevo con otra imagen.';
                }
                
                appendMessage('ai', errorMessage, true);
                
                if (isCallActive) {
                    autoRestartRecognition = false;
                    await speakText(errorMessage);
                    setTimeout(() => {
                        autoRestartRecognition = true;
                        if (isCallActive && recognition) {
                            try { recognition.start(); } catch (e) {}
                        }
                    }, 500);
                }
            } finally {
                updateModeUI();
            }
        }

        sendBtn.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        window.installPWA = function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => {
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        };

        window.hideInstallPrompt = function() {
            document.getElementById('installPrompt').classList.remove('show');
        };

        // Inicializar
        loadChats();
        updateModeUI();

        // Cerrar sidebar al hacer click fuera en móvil
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('chatSidebar');
            const menuToggle = document.getElementById('menuToggle');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('open') && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });
    })();
</script>
     <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js');
        });
    }
</script>
</body>
</html>
